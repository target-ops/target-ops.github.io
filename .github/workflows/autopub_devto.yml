name: publish
on:
  push:
    branches: [feature/autopush]
  pull_request:
    branches: [feature/autopush]

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allows writing to the repository
      pull-requests: write  # Allows creating and modifying pull requests

    steps:
    - uses: actions/checkout@v2
    
    - name: Publish articles on dev.to
      uses: sinedied/publish-devto@v2
      id: publish_devto
      with:
        devto_key: ${{ secrets.DEVTO_TOKEN }}
        github_token: ${{ secrets.GITHUB_TOKEN }}
        files: 'posts/**/*.md'
        branch: feature/autopush
        conventional_commits: true

    - name: Send dev.to link to Telegram
      if: success()  # Only run if the previous step succeeds
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}  # Add this to your GitHub secrets
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}  # Add this to your GitHub secrets
        DEVTO_ARTICLE_URL: ${{ steps.publish_devto.outputs.url }}  # Assuming this output is the article URL
      run: |
        curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
        -d chat_id=${{ env.TELEGRAM_CHAT_ID }} \
        -d text="New article published on dev.to: ${{ env.DEVTO_ARTICLE_URL }}"

    - uses: actions-ecosystem/action-create-comment@v1
      if: ${{ github.event_name == 'pull_request' }}
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        body: |
          Changes result:
          ```
          ${{ steps.publish_devto.outputs.result_summary }}
          ```
